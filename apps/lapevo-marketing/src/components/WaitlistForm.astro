---
// Uses local API route - no external URL needed
---

<section id="waitlist" class="py-20 md:py-32">
  <div class="mx-auto max-w-2xl px-6">
    <div class="rounded-2xl border border-border bg-card p-8 md:p-12">
      <!-- Header -->
      <div class="text-center mb-8">
        <h2 class="text-2xl md:text-3xl font-bold mb-3">
          Get <span class="gradient-text">Early Access</span>
        </h2>
        <p class="text-muted-foreground">
          Join the waitlist or share your ideas - email is optional for feedback
          only.
        </p>
      </div>

      <!-- Form -->
      <form id="waitlist-form" class="space-y-4">
        <!-- Email (optional for anonymous feedback) -->
        <div>
          <label
            for="email"
            class="block text-sm font-medium text-foreground mb-2"
          >
            Email address
            <span class="text-muted-foreground">(required to join waitlist)</span
            >
          </label>
          <input
            type="email"
            id="email"
            name="email"
            placeholder="you@example.com"
            class="w-full rounded-lg border border-input bg-background px-4 py-3 text-foreground placeholder:text-muted-foreground focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
          />
        </div>

        <!-- Feature Request / Feedback -->
        <div>
          <label
            for="featureRequest"
            class="block text-sm font-medium text-foreground mb-2"
          >
            What features would you like to see?
            <span class="text-muted-foreground">(optional)</span>
          </label>
          <textarea
            id="featureRequest"
            name="featureRequest"
            rows="3"
            maxlength="2000"
            placeholder="Tell us what features matter most to you, any ideas, or feedback..."
            class="w-full rounded-lg border border-input bg-background px-4 py-3 text-foreground placeholder:text-muted-foreground focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all resize-none"
          ></textarea>
          <p class="mt-1 text-xs text-muted-foreground">
            <span id="char-count">0</span>/2000 characters
          </p>
        </div>

        <!-- Submit -->
        <button
          type="submit"
          id="submit-btn"
          class="w-full rounded-lg bg-linear-to-r from-blue-500 to-blue-600 px-6 py-3 text-base font-medium text-white transition-all hover:from-blue-600 hover:to-blue-700 hover:shadow-lg hover:shadow-blue-500/25 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Submit
        </button>

        <!-- Status messages -->
        <div id="form-status" class="hidden text-center text-sm"></div>
      </form>

      <!-- Privacy note -->
      <p class="mt-6 text-center text-xs text-muted-foreground">
        We respect your privacy. No spam, ever. Unsubscribe anytime.
      </p>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById("waitlist-form") as HTMLFormElement;
  const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
  const statusDiv = document.getElementById("form-status") as HTMLDivElement;
  const emailInput = document.getElementById("email") as HTMLInputElement;
  const featureInput = document.getElementById(
    "featureRequest"
  ) as HTMLTextAreaElement;
  const charCount = document.getElementById("char-count") as HTMLSpanElement;

  // Character count for textarea
  featureInput?.addEventListener("input", () => {
    charCount.textContent = String(featureInput.value.length);
  });

  // Update button text based on form state
  function updateButtonText() {
    const hasEmail = emailInput.value.trim() !== "";
    const hasFeature = featureInput.value.trim() !== "";

    if (hasEmail && hasFeature) {
      submitBtn.textContent = "Join Waitlist & Submit Feedback";
    } else if (hasEmail) {
      submitBtn.textContent = "Join the Waitlist";
    } else if (hasFeature) {
      submitBtn.textContent = "Submit Feedback";
    } else {
      submitBtn.textContent = "Submit";
    }
  }

  emailInput?.addEventListener("input", updateButtonText);
  featureInput?.addEventListener("input", updateButtonText);

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = emailInput?.value.trim();
    const featureRequest = featureInput?.value.trim();

    // Require at least one field
    if (!email && !featureRequest) {
      statusDiv.textContent = "Please provide an email or feature request.";
      statusDiv.className = "text-center text-sm text-red-400";
      statusDiv.classList.remove("hidden");
      return;
    }

    // Disable button and show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";
    statusDiv.classList.add("hidden");

    try {
      const response = await fetch("/api/submit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          email: email || undefined,
          featureRequest: featureRequest || undefined,
          source: "landing",
        }),
      });

      const data = await response.json();

      if (data.success) {
        statusDiv.textContent = data.message;
        statusDiv.className = "text-center text-sm text-green-400";
        statusDiv.classList.remove("hidden");
        form.reset();
        charCount.textContent = "0";
        submitBtn.textContent = "Submitted!";

        // Re-enable after delay
        setTimeout(() => {
          submitBtn.disabled = false;
          updateButtonText();
        }, 3000);
      } else {
        throw new Error(data.message || "Something went wrong");
      }
    } catch (error: unknown) {
      const message =
        error instanceof Error ? error.message : "Failed to submit. Please try again.";
      statusDiv.textContent = message;
      statusDiv.className = "text-center text-sm text-red-400";
      statusDiv.classList.remove("hidden");
      submitBtn.disabled = false;
      updateButtonText();
    }
  });
</script>
